---
title: "Practicum I CS5200"
output: html_notebook
author: "Pranay Shukla"
date: "Fall 2023"
---

#Installing all required packages
```{r}
library(RMySQL)
library(sqldf)
options(sqldf.driver = "SQLite")
library(dplyr)
library(ggplot2)
```

## connect to the database
```{r connectToDatabase}
dbcon <- dbConnect(MySQL(), 
                user = "sql9656327", 
                password = "9f6LlZGTqu", 
                dbname = "sql9656327", 
                host = "sql9.freemysqlhosting.net")
```

# Checking the databases present
```{sql connection=dbcon}
SHOW DATABASES

```

# Using the DB 
```{sql connection=dbcon}
USE sql9656327
```
# Dropping tables if already exists

```{sql connection=dbcon}
DROP TABLE IF EXISTS airports
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS flights
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS conditions
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS strikes
```



# Query - 1
# Creating table flights and checking altitude has only positive values

```{sql connection=dbcon}
CREATE TABLE flights (
    fid INTEGER PRIMARY KEY,
    date DATE,
    origin INTEGER,
    airline TEXT,
    aircraft TEXT,
    altitude INTEGER CHECK (altitude >= 0),
    heavy BOOLEAN
);

```

# creating table airports

```{sql connection=dbcon}
CREATE TABLE airports(
aid INTEGER NOT NULL AUTO_INCREMENT, 
airportName TEXT NOT NULL, 
airportCode TEXT , 
airportState TEXT NOT NULL,
PRIMARY KEY(aid)
)

```

# customising flights to have foreign key

```{sql connection=dbcon}
ALTER TABLE flights
ADD CONSTRAINT fk_origin_airports
FOREIGN KEY (origin) REFERENCES airports (aid);
```

# Creating a lookup table conditions which stores the cid, condition and explanation

```{sql connection=dbcon}
CREATE TABLE conditions(
cid INTEGER NOT NULL AUTO_INCREMENT, 
`sky_condition` TEXT NOT NULL, 
explanation TEXT,
PRIMARY KEY(cid)
)
```



# creating strikes
```{sql connection=dbcon}

CREATE TABLE strikes (
    sid INTEGER PRIMARY KEY,
    fid INTEGER,
    numbirds INTEGER,
    impact TEXT,
    damage BOOLEAN,
    altitude INTEGER CHECK (altitude >= 0),
    conditions INTEGER,
    FOREIGN KEY (fid) REFERENCES flights (fid),
    FOREIGN KEY (conditions) REFERENCES conditions (cid)
);
```

# Loading the CSV file into R without filepath

```{r}
fn <- "BirdStrikesData-V2.csv"
bds.raw <- read.csv(fn, header = TRUE, stringsAsFactors = FALSE)
```

# checking if we got the csvFile
```{r}
bds.raw
```

# we store Caused damage as true and No damage as false

```{r}

bds.raw$damage <- ifelse(bds.raw$damage == 'Caused damage', TRUE, FALSE)
bds.raw
```



#populating the empty fields with unknown..
 
```{r}
options(warn = -1) 
bds.raw$airline[bds.raw$airline == ""] <- "Unknown"
```

```{r}
options(warn = -1) 
bds.raw$airline[bds.raw$airport == ""] <- "Unknown"
```

# Creating a dataframe for conditions
```{r}
cond_df <-data.frame(sky_condition= unique(bds.raw$sky_conditions))
cond_df <- cbind(cid = 1:nrow(cond_df), cond_df) 
cond_df
```
# Creating a dataframe for airports, we add rid now to populate aid in flights
# later

```{r}
airport_df <- data.frame(airportName=bds.raw$airport,airportState=bds.raw$origin)
#removing duplicates
airport_df <- airport_df %>% distinct()
airport_df <- cbind(aid = 1:nrow(airport_df), airport_df) 
airport_df
```
# Creating a strikes dataframe
```{r}
strikes_df <- data.frame(`rid` = bds.raw$rid,
  numbirds = bds.raw$wildlife_struck,
                           impact = bds.raw$impact,
                           damage=bds.raw$damage,
                           altitude = bds.raw$altitude_ft, 
                           conditions = bds.raw$sky_conditions,
                         fid = 0)
strikes_df <- cbind(sid = 1:nrow(strikes_df), strikes_df) 
strikes_df
```
# creating the flights dataframe, we use rid to reference data in airports to 
# populate the field aid
```{r}
flights_df <- data.frame(`rid` = bds.raw$rid,
  date = bds.raw$flight_date,
                           origin = bds.raw$origin,
  airport = bds.raw$airport,
                           airline=bds.raw$airline,
                           aircraft = bds.raw$aircraft, 
                           altitude = bds.raw$altitude_ft,
                           heavy = bds.raw$heavy_flag)
flights_df <- cbind(fid = 1:nrow(flights_df), flights_df) 
```
```{r}
flights_df
```
#converting the date to datetime object

```{r}
flights_df$`date` <- as.Date(flights_df$`date`, format = "%m/%d/%Y")
flights_df
```

# Checking null values for each column
```{r}

sapply(flights_df, function(x) sum(is.na(x)))

```




# Omitting the null values from flights dataframe
```{r}
flights_df <- na.omit(flights_df) 
flights_df
```

# Checking again for null values in each column
```{r}

sapply(flights_df, function(x) sum(is.na(x)))

```


# Replacing the origin in flights table with unique id (aid) from airports dataframe
```{r}
flights_df <- sqldf("SELECT fid,flights_df.rid,`date`,airline,aircraft, altitude, heavy, (SELECT aid FROM airport_df WHERE airportState = origin AND airportName = flights_df.airport ) AS origin FROM flights_df")
                   


```

```{r}
flights_df
```


#```
# changing fid in strikes to fid from flights

# changing fid in strikes to flights' fid
```{r}
strikes_df <- sqldf("
  SELECT s.sid, s.rid, f.fid, s.numbirds, s.impact, s.damage, s.altitude, s.conditions
  FROM strikes_df s
  LEFT JOIN flights_df f ON s.rid = f.rid
")
```

```{r}
strikes_df
```



# Writing the airports dataframe to airports table


```{r}
dbWriteTable(dbcon, "airports", airport_df[1:nrow(airport_df),], row.names = FALSE, append = TRUE)
```



#writing conditions df to conditions

```{r}
dbWriteTable(dbcon, "conditions", cond_df[1:nrow(cond_df),], row.names = FALSE, append = TRUE)
```




# replacing conditions with condition id in strikes df

```{r}
strikes_df <- sqldf("SELECT `rid`,sid,fid,numbirds,impact,damage,altitude,cid
AS conditions FROM strikes_df
JOIN cond_df ON strikes_df.conditions = cond_df.sky_condition")
strikes_df
```



# removing rid from strikes

```{r}
strikes_df <- sqldf("SELECT s.sid, s.fid, s.numbirds, s.impact, s.damage, s.altitude, s.conditions
  FROM strikes_df s")
```

```{r}
strikes_df
```




# populating the strikes table:- 
```{r}
dbWriteTable(dbcon, "strikes", strikes_df[1:nrow(strikes_df),], row.names = FALSE, append = TRUE)
```

# removing rid from flights

```{r}
flights_df <- sqldf("SELECT fid,`date`,airline,aircraft, altitude, heavy, origin from flights_df")
```
```{r}
flights_df
```
#populating the flights table

```{r}
dbWriteTable(dbcon, "flights", flights_df[1:nrow(flights_df),], row.names = FALSE, append = TRUE)
```



# checking if the data has been populated properly

```{sql connection = dbcon}
SELECT * from conditions LIMIT 2
```

```{sql connection = dbcon}
SELECT * from airports LIMIT 19
```
```{sql connection = dbcon}
SELECT * from flights LIMIT 7
```

```{sql connection = dbcon}
SELECT * from strikes LIMIT 17
```

```{sql connection=dbcon}
SELECT a.airportState, COUNT(s.sid) AS num_incidents
FROM strikes AS s
JOIN flights AS f ON s.fid = f.fid
JOIN airports AS a ON f.origin = a.aid
GROUP BY a.airportState
ORDER BY num_incidents DESC
LIMIT 10;

```

```{sql connection=dbcon}
SELECT f.airline, COUNT(s.sid) AS num_incidents
FROM strikes AS s
JOIN flights AS f ON s.fid = f.fid
GROUP BY f.airline
HAVING num_incidents > (SELECT AVG(num_incidents) FROM (SELECT f.airline, COUNT(s.sid) AS num_incidents FROM strikes AS s JOIN flights AS f ON s.fid = f.fid GROUP BY f.airline) AS avg_table);

```



